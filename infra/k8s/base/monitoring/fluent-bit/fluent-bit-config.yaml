apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: monitoring
data:
  fluent-bit.conf: |-
    [SERVICE]
        Flush         1
        Daemon        Off
        Log_Level     info
        Parsers_File  parsers.conf  

    [INPUT]
        Name              tail
        Tag               kube.*
        Path              /var/log/containers/*.log
        Parser            cri
        DB                /fluent-bit/tail/flb_kube.db
        Mem_Buf_Limit     50MB
        Skip_Long_Lines   On
        Refresh_Interval  10
    
        Read_from_Head    Off
        Ignore_Older      10m        
    
    
    [FILTER]
        Name              kubernetes
        Match             kube.*
        Kube_Tag_Prefix   kube.var.log.containers.
        Kube_URL          https://kubernetes.default.svc:443
        Kube_CA_File      /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        Kube_Token_File   /var/run/secrets/kubernetes.io/serviceaccount/token
        Merge_Log         On
        Merge_Log_Key     log_processed
        Keep_Log          Off
        Labels            On
    
    [FILTER]
        Name            parser
        Match           kube.*
        Key_Name        log_processed
        Parser          json
        Reserve_Data    On
  
    
    
    # 사용하지 않는 로그제거 
    [FILTER]
        Name   grep
        Match  kube.*
        Exclude log .*\/actuator\/(health|readiness|liveness).*
    
    [FILTER]
        Name    grep
        Match   kube.*
        Exclude $kubernetes['namespace_name'] kube-system
    [FILTER]
        Name    grep
        Match   kube.*
        Exclude $kubernetes['namespace_name'] monitoring
    
    
    
    [OUTPUT]
        Name        loki
        Match       kube.*
        Host        loki-service.monitoring.svc.cluster.local
        Port        3100
        Uri         /loki/api/v1/push
    
        labels      job=fluent-bit
        label_keys  $kubernetes['labels']['app'],$kubernetes['namespace_name'],$kubernetes['container_name']
        line_format json
        
        workers     1
        Retry_Limit 5
        net.keepalive on
        net.keepalive_idle_timeout 10


    [OUTPUT]
        Name          stdout
        Match         kube.*
        Format        json_lines


  parsers.conf: |-
    [PARSER]
        Name        cri
        Format      regex
        Regex       ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<log>.*)$
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L

    [PARSER]
        Name        json
        Format      json
        Time_Key    timestamp
        Time_Format %Y-%m-%dT%H:%M:%S.%L
