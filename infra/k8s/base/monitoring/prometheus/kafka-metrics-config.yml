apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-metrics-config
  namespace: spot-kafka
data:
  kafka-metrics-config.yml: |
    lowercaseOutputName: true
    rules:
      # Broker info
      - pattern: kafka.server<type=(.+), name=(.+), clientId=(.+), topic=(.+), partition=(.*)><>Value
        name: kafka_server_$1_$2
        type: GAUGE
        labels:
          clientId: "$3"
          topic: "$4"
          partition: "$5"
      - pattern: kafka.server<type=(.+), name=(.+), clientId=(.+), brokerHost=(.+), brokerPort=(.+)><>Value
        name: kafka_server_$1_$2
        type: GAUGE
        labels:
          clientId: "$3"
          broker: "$4:$5"
      - pattern: kafka.server<type=(.+), name=(.+)><>Value
        name: kafka_server_$1_$2
        type: GAUGE

      # Controller
      - pattern: kafka.controller<type=(.+), name=(.+)><>Value
        name: kafka_controller_$1_$2
        type: GAUGE

      # Network
      - pattern: kafka.network<type=(.+), name=(.+), request=(.+), version=(.+)><>Value
        name: kafka_network_$1_$2
        type: GAUGE
        labels:
          request: "$3"
          version: "$4"
      - pattern: kafka.network<type=(.+), name=(.+), request=(.*)><>Value
        name: kafka_network_$1_$2
        type: GAUGE
        labels:
          request: "$3"
      - pattern: kafka.network<type=(.+), name=(.+)><>Value
        name: kafka_network_$1_$2
        type: GAUGE

      # Log
      - pattern: kafka.log<type=(.+), name=(.+), topic=(.+), partition=(.+)><>Value
        name: kafka_log_$1_$2
        type: GAUGE
        labels:
          topic: "$3"
          partition: "$4"

      # Catch-all for remaining kafka metrics
      - pattern: kafka.(.+)<type=(.+), name=(.+)><>Value
        name: kafka_$1_$2_$3
        type: GAUGE
        
      - pattern: java.lang<type=Memory><HeapMemoryUsage>(\w+)
        name: jvm_memory_bytes_$1
        type: GAUGE
        attrNameSnakeCase: true
        labels:
          area: heap
          
      - pattern: java.lang<type=GarbageCollector, name=(.+)><>CollectionTime
        name: jvm_gc_collection_seconds_sum
        type: COUNTER
        labels:
          gc: "$1"
          
      - pattern: java.lang<type=GarbageCollector, name=(.+)><>CollectionCount
        name: jvm_gc_collection_count
        type: COUNTER
        labels:
          gc: "$1"