{
  "uid": "kafka-broker-jmx",
  "title": "Kafka Broker (JMX)",
  "tags": ["kafka", "jmx"],
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 1,
  "schemaVersion": 39,
  "refresh": "10s",
  "time": { "from": "now-1h", "to": "now" },
  "timepicker": {},
  "timezone": "",
  "links": [],
  "annotations": { "list": [] },
  "templating": { "list": [] },
  "panels": [
    {
      "id": 1,
      "title": "Active Controller",
      "description": "1이면 정상. 0이면 컨트롤러 없음 (장애)",
      "type": "stat",
      "gridPos": { "h": 4, "w": 4, "x": 0, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "red", "value": null },
              { "color": "green", "value": 1 }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
        "textMode": "auto"
      },
      "targets": [
        {
          "expr": "kafka_controller_kafkacontroller_activecontrollercount",
          "legendFormat": "Active Controller",
          "refId": "A"
        }
      ]
    },
    {
      "id": 2,
      "title": "Active Brokers",
      "type": "stat",
      "gridPos": { "h": 4, "w": 4, "x": 4, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "red", "value": null },
              { "color": "yellow", "value": 1 },
              { "color": "green", "value": 2 }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
        "textMode": "auto"
      },
      "targets": [
        {
          "expr": "kafka_controller_kafkacontroller_activebrokercount",
          "legendFormat": "Active Brokers",
          "refId": "A"
        }
      ]
    },
    {
      "id": 3,
      "title": "Offline Partitions",
      "description": "0이어야 정상. 1 이상이면 장애",
      "type": "stat",
      "gridPos": { "h": 4, "w": 4, "x": 8, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "red", "value": 1 }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
        "textMode": "auto"
      },
      "targets": [
        {
          "expr": "kafka_controller_kafkacontroller_offlinepartitionscount",
          "legendFormat": "Offline Partitions",
          "refId": "A"
        }
      ]
    },
    {
      "id": 4,
      "title": "Under Replicated Partitions",
      "description": "0이어야 정상. 부하테스트 중 증가하면 브로커 과부하",
      "type": "stat",
      "gridPos": { "h": 4, "w": 4, "x": 12, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "red", "value": 1 }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
        "textMode": "auto"
      },
      "targets": [
        {
          "expr": "kafka_server_replicamanager_underreplicatedpartitions",
          "legendFormat": "Under Replicated",
          "refId": "A"
        }
      ]
    },
    {
      "id": 5,
      "title": "Global Topic Count",
      "type": "stat",
      "gridPos": { "h": 4, "w": 4, "x": 16, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [{ "color": "blue", "value": null }]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
        "textMode": "auto"
      },
      "targets": [
        {
          "expr": "kafka_controller_kafkacontroller_globaltopiccount",
          "legendFormat": "Topics",
          "refId": "A"
        }
      ]
    },
    {
      "id": 6,
      "title": "Global Partition Count",
      "type": "stat",
      "gridPos": { "h": 4, "w": 4, "x": 20, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [{ "color": "blue", "value": null }]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false },
        "textMode": "auto"
      },
      "targets": [
        {
          "expr": "kafka_controller_kafkacontroller_globalpartitioncount",
          "legendFormat": "Partitions",
          "refId": "A"
        }
      ]
    },

    {
      "id": 10,
      "title": "Broker State",
      "description": "3 = Running 정상. 부하테스트 중 변동 시 브로커 재시작 의심",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 8, "x": 0, "y": 4 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": {
            "drawStyle": "line",
            "lineWidth": 2,
            "fillOpacity": 10,
            "pointSize": 5,
            "showPoints": "auto",
            "spanNulls": false,
            "axisLabel": "state"
          },
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "legend": { "displayMode": "list", "placement": "bottom" },
        "tooltip": { "mode": "multi", "sort": "desc" }
      },
      "targets": [
        {
          "expr": "kafka_server_kafkaserver_brokerstate",
          "legendFormat": "Broker State",
          "refId": "A"
        }
      ]
    },
    {
      "id": 11,
      "title": "Leader Count",
      "description": "브로커가 리더인 파티션 수. 부하테스트 중 급감하면 리밸런싱 발생",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 8, "x": 8, "y": 4 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": {
            "drawStyle": "line",
            "lineWidth": 2,
            "fillOpacity": 10,
            "pointSize": 5,
            "showPoints": "auto",
            "spanNulls": false,
            "axisLabel": "count"
          },
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "legend": { "displayMode": "list", "placement": "bottom" },
        "tooltip": { "mode": "multi", "sort": "desc" }
      },
      "targets": [
        {
          "expr": "kafka_server_replicamanager_leadercount",
          "legendFormat": "Leader Partitions",
          "refId": "A"
        }
      ]
    },
    {
      "id": 12,
      "title": "Partition Count",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 8, "x": 16, "y": 4 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": {
            "drawStyle": "line",
            "lineWidth": 2,
            "fillOpacity": 10,
            "pointSize": 5,
            "showPoints": "auto",
            "spanNulls": false,
            "axisLabel": "count"
          },
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "legend": { "displayMode": "list", "placement": "bottom" },
        "tooltip": { "mode": "multi", "sort": "desc" }
      },
      "targets": [
        {
          "expr": "kafka_server_replicamanager_partitioncount",
          "legendFormat": "Total Partitions",
          "refId": "A"
        },
        {
          "expr": "kafka_server_replicamanager_atminisrpartitioncount",
          "legendFormat": "At MinISR",
          "refId": "B"
        },
        {
          "expr": "kafka_server_replicamanager_underminisrpartitioncount",
          "legendFormat": "Under MinISR",
          "refId": "C"
        }
      ]
    },

    {
      "id": 20,
      "title": "Network Processor Idle %",
      "description": "낮을수록 네트워크 처리 바쁨. 부하테스트 중 0%에 가까워지면 네트워크 병목",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 12 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": {
            "drawStyle": "line",
            "lineWidth": 2,
            "fillOpacity": 10,
            "pointSize": 5,
            "showPoints": "auto",
            "spanNulls": false,
            "axisLabel": "%"
          },
          "unit": "percentunit",
          "min": 0,
          "max": 1
        },
        "overrides": []
      },
      "options": {
        "legend": { "displayMode": "table", "placement": "right", "calcs": ["mean", "min"] },
        "tooltip": { "mode": "multi", "sort": "asc" }
      },
      "targets": [
        {
          "expr": "kafka_network_socketserver_networkprocessoravgidlepercent",
          "legendFormat": "Avg Idle %",
          "refId": "A"
        }
      ]
    },
    {
      "id": 21,
      "title": "Request Queue Size",
      "description": "요청 큐가 쌓이면 브로커가 처리를 못 따라가는 것",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 12 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": {
            "drawStyle": "line",
            "lineWidth": 2,
            "fillOpacity": 10,
            "pointSize": 5,
            "showPoints": "auto",
            "spanNulls": false,
            "axisLabel": "queue size"
          },
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "legend": { "displayMode": "list", "placement": "bottom" },
        "tooltip": { "mode": "multi", "sort": "desc" }
      },
      "targets": [
        {
          "expr": "kafka_network_requestchannel_requestqueuesize",
          "legendFormat": "Request Queue",
          "refId": "A"
        },
        {
          "expr": "kafka_network_requestchannel_responsequeuesize",
          "legendFormat": "Response Queue",
          "refId": "B"
        }
      ]
    },

    {
      "id": 30,
      "title": "Disk Read/Write (bytes/s)",
      "description": "부하테스트 중 디스크 I/O 병목 확인",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 20 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": {
            "drawStyle": "line",
            "lineWidth": 2,
            "fillOpacity": 10,
            "pointSize": 5,
            "showPoints": "auto",
            "spanNulls": false,
            "axisLabel": "bytes/s"
          },
          "unit": "Bps"
        },
        "overrides": []
      },
      "options": {
        "legend": { "displayMode": "table", "placement": "right", "calcs": ["mean", "max"] },
        "tooltip": { "mode": "multi", "sort": "desc" }
      },
      "targets": [
        {
          "expr": "rate(kafka_server_kafkaserver_linux_disk_read_bytes[1m])",
          "legendFormat": "Disk Read",
          "refId": "A"
        },
        {
          "expr": "rate(kafka_server_kafkaserver_linux_disk_write_bytes[1m])",
          "legendFormat": "Disk Write",
          "refId": "B"
        }
      ]
    },
    {
      "id": 31,
      "title": "Log Size per Topic",
      "description": "토픽별 로그 크기. 부하테스트 중 빠르게 증가하면 메시지 유입 많은 것",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 20 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": {
            "drawStyle": "line",
            "lineWidth": 2,
            "fillOpacity": 10,
            "pointSize": 5,
            "showPoints": "auto",
            "spanNulls": false,
            "axisLabel": "bytes"
          },
          "unit": "bytes"
        },
        "overrides": []
      },
      "options": {
        "legend": { "displayMode": "table", "placement": "right", "calcs": ["lastNotNull", "max"] },
        "tooltip": { "mode": "multi", "sort": "desc" }
      },
      "targets": [
        {
          "expr": "kafka_log_log_size",
          "legendFormat": "{{topic}} / p{{partition}}",
          "refId": "A"
        }
      ]
    },

    {
      "id": 40,
      "title": "Delayed Produce Operations",
      "description": "Produce 요청이 지연되는 수. 부하테스트 중 증가하면 브로커 과부하",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 28 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": {
            "drawStyle": "line",
            "lineWidth": 2,
            "fillOpacity": 10,
            "pointSize": 5,
            "showPoints": "auto",
            "spanNulls": false,
            "axisLabel": "count"
          },
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "legend": { "displayMode": "list", "placement": "bottom" },
        "tooltip": { "mode": "multi", "sort": "desc" }
      },
      "targets": [
        {
          "expr": "kafka_server_delayedoperationpurgatory_numdelayedoperations_delayedoperation_produce",
          "legendFormat": "Delayed Produce",
          "refId": "A"
        },
        {
          "expr": "kafka_server_delayedoperationpurgatory_numdelayedoperations_delayedoperation_fetch",
          "legendFormat": "Delayed Fetch",
          "refId": "B"
        }
      ]
    },
    {
      "id": 41,
      "title": "Consumer Group Status",
      "description": "Stable이 정상. Rebalancing 상태가 길어지면 컨슈머 문제",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 28 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": {
            "drawStyle": "line",
            "lineWidth": 2,
            "fillOpacity": 10,
            "pointSize": 5,
            "showPoints": "auto",
            "spanNulls": false,
            "axisLabel": "count"
          },
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "legend": { "displayMode": "table", "placement": "right", "calcs": ["lastNotNull"] },
        "tooltip": { "mode": "multi", "sort": "desc" }
      },
      "targets": [
        {
          "expr": "kafka_coordinator_group_groupmetadatamanager_numgroupsstable",
          "legendFormat": "Stable",
          "refId": "A"
        },
        {
          "expr": "kafka_coordinator_group_groupmetadatamanager_numgroupspreparingrebalance",
          "legendFormat": "Preparing Rebalance",
          "refId": "B"
        },
        {
          "expr": "kafka_coordinator_group_groupmetadatamanager_numgroupscompletingrebalance",
          "legendFormat": "Completing Rebalance",
          "refId": "C"
        },
        {
          "expr": "kafka_coordinator_group_groupmetadatamanager_numgroupsdead",
          "legendFormat": "Dead",
          "refId": "D"
        }
      ]
    },
    {
      "id": 42,
      "title": "JVM Heap Memory Usage",
      "description": "JVM 힙 메모리 사용량. 90% 이상 지속 시 OOM 위험",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 36 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "drawStyle": "line", "fillOpacity": 10 },
          "unit": "bytes"
        }
      },
      "targets": [
        {
          "expr": "jvm_memory_bytes_used{area=\"heap\"}",
          "legendFormat": "Used: {{instance}}",
          "refId": "A"
        },
        {
          "expr": "jvm_memory_bytes_max{area=\"heap\"}",
          "legendFormat": "Max: {{instance}}",
          "refId": "B"
        }
      ]
    },
    {
      "id": 43,
      "title": "JVM GC Time (Rate)",
      "description": "초당 GC에 소요되는 시간. 급증 시 브로커 STW(Stop-The-World) 발생",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 36 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "drawStyle": "line", "fillOpacity": 10 },
          "unit": "s"
        }
      },
      "targets": [
        {
          "expr": "rate(jvm_gc_collection_seconds_sum[1m])",
          "legendFormat": "GC Time: {{gc}}",
          "refId": "A"
        }
      ]
    }
  ]
}